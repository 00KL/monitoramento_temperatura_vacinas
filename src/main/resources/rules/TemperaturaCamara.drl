package com.ufes.sistema_baseados_em_regras.trabalho1

//list any import classes here.
import com.ufes.sistema_baseados_em_regras.entidades.Camara;
import com.ufes.sistema_baseados_em_regras.entidades.TipoVacina;
import com.ufes.sistema_baseados_em_regras.entidades.LoteVacina;
import com.ufes.sistema_baseados_em_regras.entidades.TipoIrregularidade;
import com.ufes.sistema_baseados_em_regras.entidades.RegistroIrregularidadeTemp;
import com.ufes.sistema_baseados_em_regras.entidades.Gestor;

import java.time.LocalDateTime;
import java.text.SimpleDateFormat;


//declare any global variables here

declare Medicao
	camara: Camara
	temp: float
end


/*
rule "Checando temperatura"
    when
        $camara: Camara($num: num, $temp: tempAtual)
    then
        System.out.println("Camara " + $num + " com a temperatura de: " + $temp);
end
*/
/*Caso a temperatura de uma câmara de vacina fique fora dos limites dos
parâmetros definidos (situação grave), o gestor que estiver mais perto do local
do armazenamento da vacina deve ser chamado para comparecer ao local;*/

rule "Checando se temperatura esta proxima ao limite minimo de um lote"
	when
		$camara: Camara($num: num, $temp: tempAtual)
		$lote: LoteVacina($perigo: perigoTemperatura == false) from $camara.getLotesvacina
		$tipo: TipoVacina($tempMin: tempMin > ($temp - 1), $nome: nome) from $lote.getTipoVacina
	then
		System.out.println("CAMARA: " + $num + " -> " + "ATEN��O! Temperatura muito baixa para a vacina " + $nome + "!");
end

rule "Checando se temperatura esta proxima ao limite maximo de um lote"
	when
		$camara: Camara($num: num, $temp: tempAtual)
		$lote: LoteVacina(perigo: perigoTemperatura == false) from $camara.getLotesvacina
		$tipo: TipoVacina($tempMax: tempMax < ($temp + 1), $nome: nome) from $lote.getTipoVacina
	then
		System.out.println("CAMARA: " + $num + " -> " + "ATEN��O! Temperatura muito alta para a vacina " + $nome + "!");
end

rule "Checando se temperatura esta acima da temperatura maxima para dado tipo de vacina"
	when
		$camara: Camara($num: num, $temp: tempAtual)
		$lote: LoteVacina($perigo: perigoTemperatura == false) from $camara.getLotesvacina
		$tipo: TipoVacina($tempMax: tempMax < $temp, $nome: nome) from $lote.getTipoVacina
	then
		String msg = "CAMARA: " + $num + " -> " + "URGENTE!!! Temperatura acima da limite para a vacina " + $nome + ". Diminua a temperatura em pelo menos " + ($temp - $tempMax) + "�C";
		Gestor proximo = $camara.gestorProximo();
		proximo.sendMessage(msg);
		RegistroIrregularidadeTemp reg = new RegistroIrregularidadeTemp($camara, $lote, TipoIrregularidade.Acima_da_Temperatura);
		$lote.setPerigoTemperatura(true);
		//System.out.println(msg);
		$camara.registrarIrregularidade(reg);
end

rule "Checando se temperatura esta abaixo da temperatura minima para dado tipo de vacina"
	when
		$camara: Camara($num: num, $temp: tempAtual)
		$lote: LoteVacina($perigo: perigoTemperatura == false) from $camara.getLotesvacina
		$tipo: TipoVacina($tempMin: tempMin > $temp, $nome: nome) from $lote.getTipoVacina
	then
		String msg = "CAMARA: " + $num + " -> " + "URGENTE!!! Temperatura abaixo da limite para a vacina " + $nome + ". Diminua a temperatura em pelo menos " + ($temp - $tempMin) + "�C";
		Gestor proximo = $camara.gestorProximo();
		proximo.sendMessage(msg);
		RegistroIrregularidadeTemp reg = new RegistroIrregularidadeTemp($camara, $lote, TipoIrregularidade.Acima_da_Temperatura);
		$lote.setPerigoTemperatura(true);
		//System.out.println(msg);
		$camara.registrarIrregularidade(reg);
end

rule "Checando se um dado lote de vacina venceu"
	when
		$camara: Camara($num: num, $lotes: lotesvacina)
		$hoje: LocalDateTime() from $camara.getAgora
		$lote: LoteVacina($serial: numeroSerial, $validade: dataValidade < $hoje) from $camara.getLotesvacina
		$tipo: TipoVacina($tempMin: tempMin, $nome: nome) from $lote.getTipoVacina
		
	then
		$camara.extrairLote($lote);
		System.out.println("CAMARA: " + $num + " -> " + "DESCARTE! Lote de numero " + $serial + " de vacina do tipo " + $nome + " venceu no dia: " + $validade + ". O descarte e recomendado.");
end

rule "Checar se a irregularidade n�o foi resolvida a tempo (temp acima da maxima)"
	when
		$camara: Camara($num: num, $temp: tempAtual, $lotes: lotesvacina)
		$reg: RegistroIrregularidadeTemp($inicio: horaInicio, tipoIrreg: tipoIrregularidade == TipoIrregularidade.Acima_da_Temperatura) from $camara.getRegIrregularidade
		$lote: LoteVacina($serial: numeroSerial) from $reg.getLote
		$hoje: LocalDateTime() from $camara.getAgora
		$tipo: TipoVacina($nome: nome, $tempoMaxAcimaTempIdeal: tempoMaxAcimaTempIdeal < $reg.diferencaEmSegundos($inicio, $hoje)) from $lote.getTipoVacina
	then
		System.out.println("CAMARA: " + $num + " -> " + "DESCARTE! O lote de numero " + $serial + " de vacina do tipo " + $nome + " passou mais de " + $tempoMaxAcimaTempIdeal/60 + " minutos em temperatura acima da indicada e deve ser descartado.");
		$camara.extrairLote($lote);
		$camara.removerIrregularidade($reg);
end

rule "Checar se a irregularidade n�o foi resolvida a tempo (temp abaixo da maxima)"
	when
		$camara: Camara($num: num, $temp: tempAtual)
		$reg: RegistroIrregularidadeTemp($inicio: horaInicio, tipoIrreg: tipoIrregularidade == TipoIrregularidade.Abaixo_da_Temperatura) from $camara.getRegIrregularidade
		$lote: LoteVacina($serial: numeroSerial) from $reg.getLote
		$agora: LocalDateTime() from $camara.getAgora
		$tipo: TipoVacina($nome: nome, $tempoMaxAbaixoTempIdeal: tempoMaxAbaixoTempIdeal < $reg.diferencaEmSegundos($inicio, $agora)) from $lote.getTipoVacina
	then
		System.out.println("CAMARA: " + $num + " -> " + "DESCARTE! O lote de numero " + $serial + " de vacina do tipo " + $nome + " passou mais de " + $tempoMaxAbaixoTempIdeal/60 + " minutos em temperatura abaixo da indicada e deve ser descartado.");
		$camara.extrairLote($lote);
		$camara.removerIrregularidade($reg);
end
